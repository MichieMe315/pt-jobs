{% extends "base.html" %}
{% block title %}Checkout (PayPal) · PT Jobs{% endblock %}

{% block content %}
<div class="container my-4" style="max-width: 720px;">
  <h1 class="mb-3">Checkout (PayPal)</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-bold">{{ package.name }}</div>
          {% if package.description %}
            <div class="text-muted">{{ package.description }}</div>
          {% endif %}
          <div class="mt-2 small text-muted">
            Credits: {{ package.max_jobs }} · Duration: {{ package.duration_days }} days{% if package.allows_featured %} · Featured allowed{% endif %}
          </div>
          {% if discount_code %}
            <div class="mt-2">
              <span class="badge bg-success">DISCOUNT: {{ discount_code|upper }}</span>
            </div>
          {% endif %}
        </div>
        <div class="text-end">
          <div class="fs-4">${{ price_display }} CAD</div>
        </div>
      </div>

      <hr class="my-3"/>

      <!-- PayPal Smart Buttons -->
      <div id="paypal-buttons"></div>
      <div id="paypal-error" class="text-danger mt-2" style="display:none;"></div>

      <div class="mt-3 d-flex gap-2">
        <a href="{% url 'package_list' %}" class="btn btn-outline-secondary">Cancel</a>
      </div>
    </div>
  </div>
</div>

<!-- PayPal SDK (CAD) -->
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=CAD"></script>
<script>
  // --- CSRF helper for Django fetch() POSTs ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // Endpoints provided by server-side views
  const createUrl = "{% url 'paypal_create_order' package.code %}";
  const captureUrl = "{% url 'paypal_capture_order' package.code %}";
  const successRedirect = "{% url 'package_list' %}?success=1";

  function showError(msg) {
    const el = document.getElementById("paypal-error");
    el.style.display = "block";
    el.innerText = msg;
  }

  paypal.Buttons({
    createOrder: function () {
      return fetch(createUrl, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken }
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          showError("PayPal create order failed: " + data.error);
          throw new Error(data.error);
        }
        return data.id;
      })
      .catch(err => {
        showError("PayPal create order error: " + (err?.message || String(err)));
        throw err;
      });
    },
    onApprove: function (data) {
      return fetch(captureUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
        body: JSON.stringify({ order_id: data.orderID })
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === "COMPLETED") {
          window.location.href = successRedirect;
        } else {
          const msg = "Payment not completed" + (result.error ? (": " + result.error) : ".");
          showError(msg);
          alert(msg);
        }
      })
      .catch(err => {
        showError("PayPal capture error: " + (err?.message || String(err)));
        alert("PayPal capture error: " + (err?.message || String(err)));
      });
    },
    onError: function (err) {
      showError("PayPal error: " + (err?.message || String(err)));
    }
  }).render("#paypal-buttons");
</script>
{% endblock %}
